<template>
  <div class="messages">
    <div class="chats">
      <div class="chat-avatar">
        <img
          src="@/assets/img/user/user12.jpg"
          class="rounded-circle dreams_chat"
          alt="image"
        />
      </div>
      <div class="chat-content">
        <div class="chat-profile-name">
          <h6>
            Mark Villiams<span>8:16 PM</span
            ><span class="check-star msg-star d-none"><i class="bx bxs-star"></i></span>
          </h6>
          <div class="chat-action-btns ms-2">
            <div class="chat-action-col">
              <a class="#" href="javascript:void(0);" data-bs-toggle="dropdown">
                <i class="fa-solid fa-ellipsis"></i>
              </a>
              <div class="dropdown-menu chat-drop-menu dropdown-menu-end">
                <a href="javascript:void(0);" class="dropdown-item message-info-left"
                  ><span><i class="bx bx-info-circle"></i></span>Message Info
                </a>
                <a href="javascript:void(0);" class="dropdown-item reply-button"
                  ><span><i class="bx bx-share"></i></span>Reply</a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-smile"></i></span>React</a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-reply"></i></span>Forward</a
                >
                <a href="javascript:void(0);" class="dropdown-item click-star"
                  ><span><i class="bx bx-star"></i></span
                  ><span class="star-msg">Star Message</span></a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-dislike"></i></span>Report</a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-trash"></i></span>Delete</a
                >
              </div>
            </div>
          </div>
        </div>
        <div class="message-content">
          Hello <a href="javascript:void(0);">@Alex</a> Thank you for the beautiful web
          design ahead schedule.
        </div>
      </div>
    </div>
    <div class="chat-line">
      <span class="chat-date">Today, July 24</span>
    </div>
    <div class="chats chats-right">
      <div class="chat-content">
        <div class="chat-profile-name text-end">
          <h6>
            Alex Smith<span>8:16 PM</span
            ><span class="check-star msg-star-one d-none"
              ><i class="bx bxs-star"></i
            ></span>
          </h6>
          <div class="chat-action-btns ms-2">
            <div class="chat-action-col">
              <a class="#" href="javascript:void(0);" data-bs-toggle="dropdown">
                <i class="fa-solid fa-ellipsis"></i>
              </a>
              <div class="dropdown-menu chat-drop-menu dropdown-menu-end">
                <a href="javascript:void(0);" class="dropdown-item message-info-left"
                  ><span><i class="bx bx-info-circle"></i></span>Message Info
                </a>
                <a href="javascript:void(0);" class="dropdown-item reply-button"
                  ><span><i class="bx bx-share"></i></span>Reply</a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-smile"></i></span>React</a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-reply"></i></span>Forward</a
                >
                <a href="javascript:void(0);" class="dropdown-item click-star-one"
                  ><span><i class="bx bx-star"></i></span
                  ><span class="star-msg-one">Star Message</span></a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-edit-alt"></i></span>Edit</a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-trash"></i></span>Delete</a
                >
              </div>
            </div>
          </div>
        </div>
        <div class="message-content">
          <div class="chat-voice-group">
            <ul>
              <li>
                <a href="javascript:void(0);"
                  ><span><img src="@/assets/img/icon/play-01.svg" alt="image" /></span
                ></a>
              </li>
              <li>
                <img src="@/assets/img/icon/voice.svg" class="img-fluid" alt="image" />
              </li>
              <li>0:05</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="chat-avatar">
        <img
          src="@/assets/img/user/user2.jpg"
          class="rounded-circle dreams_chat"
          alt="image"
        />
      </div>
    </div>
    <div class="chats">
      <div class="chat-avatar">
        <img
          src="@/assets/img/user/user12.jpg"
          class="rounded-circle dreams_chat"
          alt="image"
        />
      </div>
      <div class="chat-content">
        <div class="chat-profile-name">
          <h6>
            Mark Villiams<span>8:16 PM</span
            ><span class="check-star msg-star-three d-none"
              ><i class="bx bxs-star"></i
            ></span>
          </h6>
          <div class="chat-action-btns ms-2">
            <div class="chat-action-col">
              <a class="#" href="javascript:void(0);" data-bs-toggle="dropdown">
                <i class="fa-solid fa-ellipsis"></i>
              </a>
              <div class="dropdown-menu chat-drop-menu dropdown-menu-end">
                <a href="javascript:void(0);" class="dropdown-item message-info-left"
                  ><span><i class="bx bx-info-circle"></i></span>Message Info
                </a>
                <a href="javascript:void(0);" class="dropdown-item reply-button"
                  ><span><i class="bx bx-share"></i></span>Reply</a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-smile"></i></span>React</a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-reply"></i></span>Forward</a
                >
                <a href="javascript:void(0);" class="dropdown-item click-star-three"
                  ><span><i class="bx bx-star"></i></span
                  ><span class="star-msg-three">Star Message</span></a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-dislike"></i></span>Report</a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-trash"></i></span>Delete</a
                >
              </div>
            </div>
          </div>
        </div>
        <div class="message-content award-link chat-award-link">
          <a href="javascript:void(0);">https://www.youtube.com/watch?v=GCmL3mS0Psk</a>
          <img src="@/assets/img/chat-img-01.jpg" class="img-fluid" alt="img" />
        </div>
      </div>
    </div>
    <div class="chats chats-right">
      <div class="chat-content">
        <div class="chat-profile-name text-end">
          <h6>
            Alex Smith<span>8:16 PM</span
            ><span class="check-star msg-star-one d-none"
              ><i class="bx bxs-star"></i
            ></span>
          </h6>
          <div class="chat-action-btns ms-2">
            <div class="chat-action-col">
              <a class="#" href="javascript:void(0);" data-bs-toggle="dropdown">
                <i class="fa-solid fa-ellipsis"></i>
              </a>
              <div class="dropdown-menu chat-drop-menu dropdown-menu-end">
                <a href="javascript:void(0);" class="dropdown-item message-info-left"
                  ><span><i class="bx bx-info-circle"></i></span>Message Info
                </a>
                <a href="javascript:void(0);" class="dropdown-item reply-button"
                  ><span><i class="bx bx-share"></i></span>Reply</a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-smile"></i></span>React</a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-reply"></i></span>Forward</a
                >
                <a href="javascript:void(0);" class="dropdown-item click-star-one"
                  ><span><i class="bx bx-star"></i></span
                  ><span class="star-msg-one">Star Message</span></a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-edit-alt"></i></span>Edit</a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-trash"></i></span>Delete</a
                >
              </div>
            </div>
          </div>
        </div>
        <div class="message-content">
          Thankyou for the notes sir. Will you send me the location where I could bought?
        </div>
      </div>
      <div class="chat-avatar">
        <img
          src="@/assets/img/user/user2.jpg"
          class="rounded-circle dreams_chat"
          alt="image"
        />
      </div>
    </div>

    <div class="chats">
      <div class="chat-avatar">
        <img
          src="@/assets/img/user/user12.jpg"
          class="rounded-circle dreams_chat"
          alt="image"
        />
      </div>
      <div class="chat-content">
        <div class="chat-profile-name">
          <h6>
            Mark Villiams<span>8:16 PM</span
            ><span class="check-star msg-star-five d-none"
              ><i class="bx bxs-star"></i
            ></span>
          </h6>
          <div class="chat-action-btns ms-2">
            <div class="chat-action-col">
              <a class="#" href="javascript:void(0);" data-bs-toggle="dropdown">
                <i class="fa-solid fa-ellipsis"></i>
              </a>
              <div class="dropdown-menu chat-drop-menu dropdown-menu-end">
                <a href="javascript:void(0);" class="dropdown-item message-info-left"
                  ><span><i class="bx bx-info-circle"></i></span>Message Info
                </a>
                <a href="javascript:void(0);" class="dropdown-item reply-button"
                  ><span><i class="bx bx-share"></i></span>Reply</a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-smile"></i></span>React</a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-reply"></i></span>Forward</a
                >
                <a href="javascript:void(0);" class="dropdown-item click-star-five"
                  ><span><i class="bx bx-star"></i></span
                  ><span class="star-msg-five">Star Message</span></a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-dislike"></i></span>Report</a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-trash"></i></span>Delete</a
                >
              </div>
            </div>
          </div>
        </div>
        <div class="message-content">
          <div class="location-sharing">
            <div class="sharing-location-icon">
              <i class="fa-solid fa-location-dot"></i>
            </div>
            <h6>My Location <a href="#">Download</a></h6>
          </div>
        </div>
        <div class="like-chat-grp">
          <ul>
            <li class="like-chat">
              <a href="javascript:void(0);"
                >2<img src="@/assets/img/icon/like.svg" alt="Icon"
              /></a>
            </li>
            <li class="comment-chat">
              <a href="javascript:void(0);"
                >2<img src="@/assets/img/icon/heart.svg" alt="Icon"
              /></a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <div class="chats"
          v-for="(message, index) in messages" :key="index"
          :class="{'chats-right': message.idUserTo == user.id }">
      <div class="chat-avatar">
        <img :src="message.avatarUserTo"
          class="rounded-circle dreams_chat"
          alt="image"/>
      </div>
      <div class="chat-content">
        <div class="chat-profile-name">
          <h6>
            {{ message.nameUserTo }}<span>18:00</span><span class="check-star msg-star d-none"><i class="bx bxs-star"></i></span>
          </h6>
          <div class="chat-action-btns ms-2">
            <div class="chat-action-col">
              <a class="#" href="javascript:void(0);" data-bs-toggle="dropdown">
                <i class="fa-solid fa-ellipsis"></i>
              </a>
              <div class="dropdown-menu chat-drop-menu dropdown-menu-end">
                <a href="javascript:void(0);" class="dropdown-item message-info-left"
                  ><span><i class="bx bx-info-circle"></i></span>Message Info
                </a>
                <a href="javascript:void(0);" class="dropdown-item reply-button"
                  ><span><i class="bx bx-share"></i></span>Reply</a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-smile"></i></span>React</a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-reply"></i></span>Forward</a
                >
                <a href="javascript:void(0);" class="dropdown-item click-star"
                  ><span><i class="bx bx-star"></i></span
                  ><span class="star-msg">Star Message</span></a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-edit-alt"></i></span>Report</a
                >
                <a href="javascript:void(0);" class="dropdown-item"
                  ><span><i class="bx bx-trash"></i></span>Delete</a
                >
              </div>
            </div>
          </div>
        </div>
        <div class="message-content reply-getcontent">{{ message.message }}</div>
      </div>
    </div>
  </div>
</template>
<script>
import * as StompJs from "@stomp/stompjs";
import SockJS from "sockjs-client";
import baseApi from "@/axios";
import { useStore } from "vuex";
import { ref } from "vue";
export default {
  data(){
    const store = useStore();
    const user = ref(store.state.userInfo);
    return {
      user,
      userFrom: "bc7b0320-2fbf-4aa1-aee6-0735cc35d38b",
      messages:[],
      messageInput: "",
    }
  },
  created() {
    this.getMessage()
    this.connectSocket()
  },
  methods: {
    getMessage(){
      baseApi.get(`/messages/${this.user.id}/${this.userFrom}`)
      .then(message => {
        this.messages = message.data
        console.log("Tải dữ liệu tin nhắn thành công: ", this.messages)
      })
      .catch(error => {
        console.log("Truy xuất tin nhắn thất bại: ", error)
      })
    },
    sendMessage(){
      if(this.messageInput != null) {
        if(this.stompClient && this.stompClient.connected){
          this.stompClient.publish({
            destination: "/app/messages/send",
            body: JSON.stringify({
              id: null,
              message: this.message,
              idUserTo: this.user.id,
              idUserFrom: "df07c91f-32fe-4f7a-8263-89781810fe5a",
              idCourse: null,
              createdAt: null,
              type: "text"
            }),
          });
          console.log("Đã gửi bình luận qua WebSocket");
        }
      } 
    },
    connectSocket() {
      this.stompClient = new StompJs.Client({
        webSocketFactory: () => new SockJS("http://localhost:8080/ws"),
        debug: (str) => {
          console.log("Thông tin gỡ lỗi", str);
        },
        onConnect: (frame) => {
          console.log("Kết nối socket thành công!", frame);
          this.stompClient.subscribe("/topic/messages", (message) => {
            try {
              const messageData = JSON.parse(message.body);
              console.log("Nhận bình luận:", messageData);

              if (this.messages != null) {
                const index = this.messages.findIndex(
                  (comment) => comment.id === messages.id
                );
                if (index !== -1) {
                  // Nếu bình luận đã tồn tại, cập nhật nó
                  this.messages[index].message = messageData.message;
                } else {
                  // Nếu bình luận chưa tồn tại, thêm mới
                  this.messages.push(messageData);
                }
              } else {
                // Nếu bình luận chưa tồn tại, thêm mới
                this.messages = [];
                this.messages.push(messageData);
              }
            } catch (error) {
              console.error("Không thể phân tích JSON:", error);
              console.error("Nội dung nhận được:", message.body);
            }
          });
        },
        onStompError: (frame) => {
          console.error("Broker reported error: " + frame.headers["message"]);
          console.error("Additional details: " + frame.body);
        },
      });
      this.stompClient.activate();
    },
  },
  beforeUnmount() {
    if (this.stompClient) {
      this.stompClient.deactivate();
    }
  },
}
</script>